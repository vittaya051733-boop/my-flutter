import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:image_picker/image_picker.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'dart:io';
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'map_picker_screen.dart';
import 'package:google_mlkit_text_recognition/google_mlkit_text_recognition.dart';

class ShopRegistrationScreen extends StatefulWidget {
  final String? serviceType;
  
  const ShopRegistrationScreen({super.key, this.serviceType});

  @override
  State<ShopRegistrationScreen> createState() => _ShopRegistrationScreenState();
}

class _ShopRegistrationScreenState extends State<ShopRegistrationScreen> {
  final _formKey = GlobalKey<FormState>();
  AutovalidateMode _autoValidateMode = AutovalidateMode.disabled;
  final _shopNameController = TextEditingController();
  final _shopDescriptionController = TextEditingController();
  final _addressController = TextEditingController();
  final _phoneController = TextEditingController();
  final _emailController = TextEditingController();
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
  final _bankNameController = TextEditingController();
  final _accountNumberController = TextEditingController();
  final _accountOwnerController = TextEditingController();
  
  // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  static const List<String> _thaiBanks = <String>[
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBank)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ (BAY)',
    '‡∏ó‡∏µ‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï (TTB)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ (UOB)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ‡πÑ‡∏ó‡∏¢ (CIMB)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô‡∏†‡∏±‡∏ó‡∏£ (KKP)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏¥‡∏™‡πÇ‡∏Å‡πâ (TISCO)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏ô‡∏î‡πå‡πÅ‡∏≠‡∏ô‡∏î‡πå‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå (LH Bank)',
    '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô',
    '‡∏ò.‡∏Å.‡∏™. (‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£)',
    '‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
  ];
  
  File? _selectedImage;
  bool _isUploading = false;
  bool _isSaving = false;
  
  File? _selectedBookBankImage;
  bool _isUploadingBookBank = false;
  
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏• OCR ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  String _ocrText = '';
  
  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö real-time
  String? _bankNameError;
  String? _accountNumberError;
  String? _accountOwnerError;
  
  // ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
  double? _latitude;
  double? _longitude;

  @override
  void initState() {
    super.initState();
    _loadUserEmail();
  }

  Future<void> _loadUserEmail() async {
    final user = FirebaseAuth.instance.currentUser;
    if (user != null && user.email != null) {
      setState(() {
        _emailController.text = user.email!;
      });
    }
  }

  @override
  void dispose() {
    _shopNameController.dispose();
    _shopDescriptionController.dispose();
    _addressController.dispose();
    _phoneController.dispose();
    _emailController.dispose();
    _bankNameController.dispose();
    _accountNumberController.dispose();
    _accountOwnerController.dispose();
    super.dispose();
  }

  Future<void> _pickImage() async {
    final ImagePicker picker = ImagePicker();
    final XFile? image = await picker.pickImage(
      source: ImageSource.gallery,
      maxWidth: 1200,
      maxHeight: 1200,
      imageQuality: 85,
    );

    if (image != null) {
      setState(() {
        _selectedImage = File(image.path);
      });
      _showSnackBar('‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', Colors.green);
    }
  }

  Future<String?> _uploadImage() async {
    if (_selectedImage == null) return null;

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) throw Exception('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');

      final timestamp = DateTime.now().millisecondsSinceEpoch;
      final fileName = 'shop_images/${user.uid}_$timestamp.jpg';
      
      final storageRef = FirebaseStorage.instance.ref().child(fileName);
      final uploadTask = await storageRef.putFile(_selectedImage!);
      final downloadUrl = await uploadTask.ref.getDownloadURL();

      return downloadUrl;
    } catch (e) {
      throw Exception('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: $e');
    }
  }

  Future<void> _pickBookBankImage() async {
    final ImagePicker picker = ImagePicker();
    final XFile? image = await picker.pickImage(
      source: ImageSource.gallery,
      maxWidth: 1400,
      maxHeight: 1400,
      imageQuality: 90,
    );

    if (image != null) {
      setState(() {
        _selectedBookBankImage = File(image.path);
      });
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      final isValid = await _validateBookBankImage(File(image.path));
      
      if (!isValid) {
        setState(() {
          _selectedBookBankImage = null;
        });
        return;
      }
      
      _showSnackBar('‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', Colors.green);
      
      // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ AI ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      if (_ocrText.isNotEmpty) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        if (_bankNameController.text.isNotEmpty) {
          _validateFieldAgainstOCR('bank');
        }
        if (_accountNumberController.text.isNotEmpty) {
          _validateFieldAgainstOCR('account');
        }
        if (_accountOwnerController.text.isNotEmpty) {
          _validateFieldAgainstOCR('owner');
        }
      }
    }
  }

  Future<String?> _uploadBookBankImage() async {
    if (_selectedBookBankImage == null) return null;

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) throw Exception('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');

      final timestamp = DateTime.now().millisecondsSinceEpoch;
      final fileName = 'bookbank_images/${user.uid}_$timestamp.jpg';
      
      final storageRef = FirebaseStorage.instance.ref().child(fileName);
      final uploadTask = await storageRef.putFile(_selectedBookBankImage!);
      final downloadUrl = await uploadTask.ref.getDownloadURL();

      return downloadUrl;
    } catch (e) {
      throw Exception('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: $e');
    }
  }

  // ‡πÉ‡∏ä‡πâ OpenAI GPT-4 Vision ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
  Future<Map<String, String>?> _extractStructuredDataWithAI(File imageFile) async {
    try {
      final bytes = await imageFile.readAsBytes();
      final base64Image = base64Encode(bytes);
      
      // TODO: ‡πÉ‡∏™‡πà OpenAI API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
      const openaiApiKey = 'YOUR_OPENAI_API_KEY_HERE';
      
      if (openaiApiKey == 'YOUR_OPENAI_API_KEY_HERE') {
        print('‚ö†Ô∏è OpenAI API Key not configured, skipping structured extraction');
        return null;
      }
      
      final url = Uri.parse('https://api.openai.com/v1/chat/completions');
      
      final requestBody = jsonEncode({
        'model': 'gpt-4o-mini', // ‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏î‡∏µ‡∏û‡∏≠
        'messages': [
          {
            'role': 'user',
            'content': [
              {
                'type': 'text',
                'text': '''‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥ 2 ‡∏™‡∏¥‡πà‡∏á:

1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:
   - ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡πÄ‡∏ö‡∏•‡∏≠‡∏°‡∏≤‡∏Å ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà "imageQuality": "poor"
   - ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà "imageQuality": "good"
   - ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô "qualityReason"

2. ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
   - ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡πÄ‡∏ï‡πá‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢)
   - ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏µ‡∏î)
   - ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏ï‡πá‡∏°)

‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
{
  "imageQuality": "good" ‡∏´‡∏£‡∏∑‡∏≠ "poor",
  "qualityReason": "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•",
  "bankName": "‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£" ‡∏´‡∏£‡∏∑‡∏≠ null,
  "accountNumber": "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" ‡∏´‡∏£‡∏∑‡∏≠ null,
  "accountOwner": "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" ‡∏´‡∏£‡∏∑‡∏≠ null
}'''
              },
              {
                'type': 'image_url',
                'image_url': {
                  'url': 'data:image/jpeg;base64,$base64Image'
                }
              }
            ]
          }
        ],
        'max_tokens': 400,
        'temperature': 0.2
      });
      
      final response = await http.post(
        url,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $openaiApiKey',
        },
        body: requestBody,
      );
      
      if (response.statusCode == 200) {
        final jsonResponse = jsonDecode(response.body);
        final content = jsonResponse['choices'][0]['message']['content'] as String;
        
        print('ü§ñ OpenAI Response: $content');
        
        // Parse JSON ‡∏à‡∏≤‡∏Å response
        final jsonMatch = RegExp(r'\{[^\}]+\}').firstMatch(content);
        if (jsonMatch != null) {
          final extractedJson = jsonDecode(jsonMatch.group(0)!);
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô
          if (extractedJson['imageQuality'] == 'poor') {
            final reason = extractedJson['qualityReason'] ?? '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô';
            throw Exception('IMAGE_QUALITY_POOR:$reason');
          }
          
          final result = <String, String>{};
          if (extractedJson['bankName'] != null && extractedJson['bankName'] != 'null') {
            result['bankName'] = extractedJson['bankName'];
          }
          if (extractedJson['accountNumber'] != null && extractedJson['accountNumber'] != 'null') {
            result['accountNumber'] = extractedJson['accountNumber'].toString().replaceAll(RegExp(r'[\s\-]'), '');
          }
          if (extractedJson['accountOwner'] != null && extractedJson['accountOwner'] != 'null') {
            result['accountOwner'] = extractedJson['accountOwner'];
          }
          
          print('‚úÖ OpenAI Structured Data: $result');
          return result.isEmpty ? null : result;
        }
      } else {
        print('‚ùå OpenAI API Error: ${response.statusCode} - ${response.body}');
      }
      
      return null;
    } catch (e) {
      if (e.toString().contains('IMAGE_QUALITY_POOR')) {
        rethrow; // ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ error ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      }
      print('‚ùå OpenAI Exception: $e');
      return null;
    }
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Google Cloud Vision API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ
  Future<String> _extractTextWithVisionAPI(File imageFile) async {
    try {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô base64
      final bytes = await imageFile.readAsBytes();
      final base64Image = base64Encode(bytes);
      
      // API Key ‡∏Ç‡∏≠‡∏á Google Cloud Vision
      const apiKey = 'AIzaSyAIKueErj1mUOBDCjPZD9tEyM7Kf7iNfwI';
      final url = Uri.parse('https://vision.googleapis.com/v1/images:annotate?key=$apiKey');
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á request body
      final requestBody = jsonEncode({
        'requests': [
          {
            'image': {'content': base64Image},
            'features': [
              {'type': 'DOCUMENT_TEXT_DETECTION', 'maxResults': 1}
            ],
            'imageContext': {
              'languageHints': ['th', 'en'] // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
            }
          }
        ]
      });
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
      final response = await http.post(
        url,
        headers: {'Content-Type': 'application/json'},
        body: requestBody,
      );
      
      if (response.statusCode == 200) {
        final jsonResponse = jsonDecode(response.body);
        final textAnnotations = jsonResponse['responses'][0]['textAnnotations'];
        
        if (textAnnotations != null && textAnnotations.isNotEmpty) {
          // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô element ‡πÅ‡∏£‡∏Å
          final fullText = textAnnotations[0]['description'] as String;
          print('‚úÖ Vision API Success: ${fullText.length} chars extracted');
          return fullText.toLowerCase();
        } else {
          print('‚ö†Ô∏è Vision API: No text found');
          return '';
        }
      } else {
        print('‚ùå Vision API Error: ${response.statusCode} - ${response.body}');
        return '';
      }
    } catch (e) {
      print('‚ùå Vision API Exception: $e');
      return '';
    }
  }

  Future<bool> _validateBookBankImage(File imageFile) async {
    try {
      // ‡πÅ‡∏™‡∏î‡∏á loading
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Row(
              children: [
                CircularProgressIndicator(color: Colors.white),
                SizedBox(width: 16),
                Text('ü§ñ AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...'),
              ],
            ),
            duration: Duration(seconds: 15),
          ),
        );
      }

      // ‡πÉ‡∏ä‡πâ OpenAI ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Vision API ‡∏´‡∏£‡∏∑‡∏≠ ML Kit
      print('ü§ñ Using OpenAI for analysis...');
      Map<String, String>? structuredData;
      
      try {
        structuredData = await _extractStructuredDataWithAI(imageFile);
      } catch (e) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô error ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏•‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (e.toString().contains('IMAGE_QUALITY_POOR')) {
          final reason = e.toString().split(':').last;
          
          if (mounted) {
            ScaffoldMessenger.of(context).clearSnackBars();
            
            // ‡πÅ‡∏™‡∏î‡∏á dialog ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            final retry = await showDialog<bool>(
              context: context,
              barrierDismissible: false,
              builder: (context) => AlertDialog(
                title: Row(
                  children: [
                    Icon(Icons.warning, color: Colors.orange),
                    SizedBox(width: 8),
                    Expanded(child: Text('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô')),
                  ],
                ),
                content: Column(
                  mainAxisSize: MainAxisSize.min,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô',
                      style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                    ),
                    SizedBox(height: 12),
                    Container(
                      padding: EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.orange.shade50,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: Colors.orange.shade200),
                      ),
                      child: Text(
                        reason,
                        style: TextStyle(color: Colors.orange.shade900),
                      ),
                    ),
                    SizedBox(height: 16),
                    Text('‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:', style: TextStyle(fontWeight: FontWeight.bold)),
                    SizedBox(height: 8),
                    Text('‚Ä¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠'),
                    Text('‚Ä¢ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô'),
                    Text('‚Ä¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ï‡∏£‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏µ‡∏¢‡∏á'),
                    Text('‚Ä¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'),
                    Text('‚Ä¢ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏á‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏á‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô'),
                  ],
                ),
                actions: [
                  TextButton(
                    onPressed: () => Navigator.pop(context, false),
                    child: Text('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'),
                  ),
                  ElevatedButton.icon(
                    onPressed: () => Navigator.pop(context, true),
                    icon: Icon(Icons.camera_alt),
                    label: Text('‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.orange,
                      foregroundColor: Colors.white,
                    ),
                  ),
                ],
              ),
            );
            
            if (retry == true) {
              // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
              setState(() {
                _selectedBookBankImage = null;
              });
            }
          }
          
          return false;
        }
        
        // Error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        print('‚ùå OpenAI error: $e');
        if (mounted) {
          ScaffoldMessenger.of(context).clearSnackBars();
          _showSnackBar('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', Colors.red);
        }
        return false;
      }
      
      // ‡∏õ‡∏¥‡∏î loading
      if (mounted) {
        ScaffoldMessenger.of(context).clearSnackBars();
      }
      
      if (structuredData != null && structuredData.isNotEmpty) {
        // AI ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÅ‡∏™‡∏î‡∏á dialog ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        if (mounted) {
          final confirmed = await _showAutoFillConfirmationDialog(structuredData);
          
          if (confirmed == true) {
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            setState(() {
              final data = structuredData!;
              if (data['bankName'] != null) {
                // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÉ‡∏ô dropdown
                final bankName = data['bankName']!;
                for (final bank in _thaiBanks) {
                  if (bank.toLowerCase().contains(bankName.toLowerCase()) ||
                      bankName.toLowerCase().contains(bank.toLowerCase())) {
                    _bankNameController.text = bank;
                    break;
                  }
                }
              }
              if (data['accountNumber'] != null) {
                _accountNumberController.text = data['accountNumber']!;
              }
              if (data['accountOwner'] != null) {
                _accountOwnerController.text = data['accountOwner']!;
              }
              
              // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AI ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô _ocrText ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
              final ocrTextParts = <String>[];
              if (data['bankName'] != null) ocrTextParts.add(data['bankName']!);
              if (data['accountNumber'] != null) ocrTextParts.add(data['accountNumber']!);
              if (data['accountOwner'] != null) ocrTextParts.add(data['accountOwner']!);
              _ocrText = ocrTextParts.join(' ').toLowerCase();
            });
            
            _showSnackBar('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AI ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', Colors.green);
          } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô _ocrText ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö manual
            setState(() {
              final data = structuredData!;
              final ocrTextParts = <String>[];
              if (data['bankName'] != null) ocrTextParts.add(data['bankName']!);
              if (data['accountNumber'] != null) ocrTextParts.add(data['accountNumber']!);
              if (data['accountOwner'] != null) ocrTextParts.add(data['accountOwner']!);
              _ocrText = ocrTextParts.join(' ').toLowerCase();
            });
          }
        }
        
        return true;
      } else {
        // AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
        _showSnackBar('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏ô‡∏£‡∏π‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà', Colors.orange);
        return false;
      }
      
    } catch (e) {
      print('‚ùå Error in _validateBookBankImage: $e');
      if (mounted) {
        ScaffoldMessenger.of(context).clearSnackBars();
        _showSnackBar('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e.toString()}', Colors.red);
      }
      return false;
    }
  }
                ],
              ),
            );
            
            if (retry == true) {
              // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
              setState(() {
                _selectedBookBankImage = null;
              });
            }
          }
          
          return false;
        }
        
        // Error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ
        print('‚ùå OpenAI error (not quality): $e');
      }
      
      if (structuredData != null && structuredData.isNotEmpty) {
        // AI ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÅ‡∏™‡∏î‡∏á dialog ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        if (mounted) {
          ScaffoldMessenger.of(context).clearSnackBars();
          final confirmed = await _showAutoFillConfirmationDialog(structuredData);
          
          if (confirmed == true) {
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            setState(() {
              final data = structuredData!;
              if (data['bankName'] != null) {
                // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÉ‡∏ô dropdown
                final bankName = data['bankName']!;
                for (final bank in _thaiBanks) {
                  if (bank.toLowerCase().contains(bankName.toLowerCase()) ||
                      bankName.toLowerCase().contains(bank.toLowerCase())) {
                    _bankNameController.text = bank;
                    break;
                  }
                }
              }
              if (data['accountNumber'] != null) {
                _accountNumberController.text = data['accountNumber']!;
              }
              if (data['accountOwner'] != null) {
                _accountOwnerController.text = data['accountOwner']!;
              }
            });
            
            _showSnackBar('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AI ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', Colors.green);
          }
        }
      }
      
      // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏ä‡πâ Vision API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö real-time validation)
      print('üîç Starting Vision API OCR...');
      String allText = await _extractTextWithVisionAPI(imageFile);
      int blockCount = allText.split('\n').length;
      
      // ‡∏ñ‡πâ‡∏≤ Vision API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏• ‡∏•‡∏≠‡∏á ML Kit ‡∏™‡∏≥‡∏£‡∏≠‡∏á
      if (allText.isEmpty) {
        print('‚ö†Ô∏è Vision API failed, trying ML Kit fallback...');
        try {
          final textRecognizer = TextRecognizer();
          final inputImage = InputImage.fromFile(imageFile);
          final recognizedText = await textRecognizer.processImage(inputImage);
          await textRecognizer.close();
          
          allText = recognizedText.text.toLowerCase();
          blockCount = recognizedText.blocks.length;
          print('üìù ML Kit Fallback: ${allText.length} chars, ${blockCount} blocks');
        } catch (e) {
          print('‚ùå ML Kit also failed: $e');
          if (structuredData == null || structuredData.isEmpty) {
            _showSnackBar('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', Colors.red);
            return false;
          }
        }
      }
      
      // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
      print('üìù Final OCR Result: ${allText.length} chars');
      print('üìù OCR Text (first 300 chars): ${allText.substring(0, allText.length > 300 ? 300 : allText.length)}');
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å OCR text ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö real-time
      setState(() {
        _ocrText = allText;
      });
      
      // ‡πÅ‡∏™‡∏î‡∏á snackbar ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° OCR
      if (mounted && allText.isNotEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ ${allText.length} ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'),
            backgroundColor: Colors.blue,
            duration: Duration(seconds: 2),
            action: SnackBarAction(
              label: '‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°',
              textColor: Colors.white,
              onPressed: () {
                _showOCRPreviewDialog(allText);
              },
            ),
          ),
        );
      }
      
      // ‡∏õ‡∏¥‡∏î loading
      if (mounted) {
        ScaffoldMessenger.of(context).clearSnackBars();
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô: ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (allText.trim().isEmpty) {
        _showValidationDialog([
          '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ',
          '',
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤:',
          '‚Ä¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠',
          '‚Ä¢ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô',
          '‚Ä¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ï‡∏£‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏µ‡∏¢‡∏á',
        ]);
        return false;
      }
      
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
      final bankName = _bankNameController.text.trim().toLowerCase();
      final accountNumber = _accountNumberController.text.trim().replaceAll(RegExp(r'[\s\-]'), '');
      final accountOwner = _accountOwnerController.text.trim().toLowerCase();
      
      final errors = <String>[];
      
      // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
      if (bankName.isNotEmpty) {
        // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢" -> ["‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£", "‡∏Å‡∏™‡∏¥‡∏Å‡∏£", "‡πÑ‡∏ó‡∏¢"]
        final bankWords = bankName.split(RegExp(r'\s+'));
        bool foundBank = false;
        
        for (final word in bankWords) {
          if (word.length >= 3 && allText.contains(word)) {
            foundBank = true;
            break;
          }
        }
        
        if (!foundBank) {
          errors.add('‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å "$bankName"');
        }
      }
      
      // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
      if (accountNumber.isNotEmpty && accountNumber.length >= 8) {
        final cleanedText = allText.replaceAll(RegExp(r'[\s\-]'), '');
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 70%
        bool foundNumber = false;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°
        if (cleanedText.contains(accountNumber)) {
          foundNumber = true;
        } else {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (70% ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç)
          final minMatch = (accountNumber.length * 0.7).round();
          for (int i = 0; i <= accountNumber.length - minMatch; i++) {
            final substring = accountNumber.substring(i, i + minMatch);
            if (cleanedText.contains(substring)) {
              foundNumber = true;
              break;
            }
          }
        }
        
        if (!foundNumber) {
          errors.add('‚Ä¢ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å');
        }
      }
      
      // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
      if (accountOwner.isNotEmpty) {
        // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" -> ["‡∏ô‡∏≤‡∏¢", "‡∏™‡∏°‡∏ä‡∏≤‡∏¢", "‡πÉ‡∏à‡∏î‡∏µ"]
        final nameWords = accountOwner.split(RegExp(r'\s+'));
        int matchedWords = 0;
        
        for (final word in nameWords) {
          if (word.length >= 2 && allText.contains(word)) {
            matchedWords++;
          }
        }
        
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 50% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥
        if (matchedWords < (nameWords.length * 0.5)) {
          errors.add('‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å "$accountOwner"');
        }
      }
      
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
      if (errors.isNotEmpty) {
        _showValidationDialog([
          '‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å',
          '',
          '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:',
          ...errors,
          '',
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤:',
          '‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
          '‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        ]);
        return false;
      }
      
      // ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° = ‡∏ú‡πà‡∏≤‡∏ô
      if (allText.length > 10 || blockCount > 1) {
        _showSnackBar('‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', Colors.green);
        return true;
      }
      
      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å
      _showValidationDialog([
        '‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô',
        '',
        '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà:',
        '‚Ä¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô',
        '‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á',
        '‚Ä¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
      ]);
      
      return false;

    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).clearSnackBars();
      }
      _showSnackBar('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ: $e', Colors.red);
      return false;
    }
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö OCR ‡πÅ‡∏ö‡∏ö real-time
  void _validateFieldAgainstOCR(String fieldName) {
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ OCR text ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
    if (_ocrText.isEmpty || _selectedBookBankImage == null) {
      return;
    }

    setState(() {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
      if (fieldName == 'bank' || fieldName == 'all') {
        final bankNameRaw = _bankNameController.text.trim().toLowerCase();
        if (bankNameRaw.isNotEmpty) {
          // ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (BBL), (KBank) ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£" ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ã‡πâ‡∏≥
          final bankName = bankNameRaw
              .replaceAll(RegExp(r'\([^)]*\)'), '') // ‡∏ï‡∏±‡∏î‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô
              .replaceAll('‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', '')
              .replaceAll('‡∏ò.‡∏Å.‡∏™.', '‡∏ò‡∏Å‡∏™')
              .replaceAll(RegExp(r'[^\u0E00-\u0E7Fa-z0-9\s]'), '') // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà‡πÑ‡∏ó‡∏¢ ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
              .trim();
          
          final bankWords = bankName.split(RegExp(r'\s+'));
          bool foundBank = false;
          
          for (final word in bankWords) {
            if (word.length >= 3 && _ocrText.contains(word)) {
              foundBank = true;
              break;
            }
          }
          
          // Debug: ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏î‡∏π
          print('üè¶ Bank check: "$bankName" -> words: $bankWords -> found: $foundBank');
          
          _bankNameError = foundBank ? null : '‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
        } else {
          _bankNameError = null;
        }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
      if (fieldName == 'account' || fieldName == 'all') {
        final accountNumber = _accountNumberController.text.trim().replaceAll(RegExp(r'[\s\-\.]'), '');
        if (accountNumber.isNotEmpty && accountNumber.length >= 8) {
          // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î OCR: ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
          final cleanedOCR = _ocrText.replaceAll(RegExp(r'[^\d]'), '');
          
          bool foundNumber = false;
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° (100%)
          if (cleanedOCR.contains(accountNumber)) {
            foundNumber = true;
            print('üî¢ Account: ‡∏ï‡∏£‡∏á 100% "$accountNumber"');
          } else {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (50% ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ OCR ‡∏ú‡∏¥‡∏î‡∏ö‡πâ‡∏≤‡∏á)
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 10 ‡∏´‡∏•‡∏±‡∏Å = ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô
            final minMatch = (accountNumber.length * 0.5).round().clamp(4, accountNumber.length);
            
            // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
            for (int i = 0; i <= accountNumber.length - minMatch; i++) {
              final substring = accountNumber.substring(i, i + minMatch);
              if (cleanedOCR.contains(substring)) {
                foundNumber = true;
                print('üî¢ Account: ‡∏û‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô "$substring" (${minMatch} ‡∏´‡∏•‡∏±‡∏Å)');
                break;
              }
            }
            
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏ö‡∏ö flexible ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (40% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å = 4 ‡∏´‡∏•‡∏±‡∏Å)
            if (!foundNumber && accountNumber.length >= 10) {
              final relaxedMatch = 4;
              for (int i = 0; i <= accountNumber.length - relaxedMatch; i++) {
                final substring = accountNumber.substring(i, i + relaxedMatch);
                if (cleanedOCR.contains(substring)) {
                  foundNumber = true;
                  print('üî¢ Account: ‡∏û‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (relaxed) "$substring" (${relaxedMatch} ‡∏´‡∏•‡∏±‡∏Å)');
                  break;
                }
              }
            }
          }
          
          // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
          print('üî¢ Account Input: "$accountNumber" (${accountNumber.length} ‡∏´‡∏•‡∏±‡∏Å)');
          print('üî¢ OCR Digits: "$cleanedOCR"');
          print('üî¢ Result: ${foundNumber ? "‚úÖ ‡∏ú‡πà‡∏≤‡∏ô" : "‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"}');
          
          _accountNumberError = foundNumber ? null : '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
        } else {
          _accountNumberError = null;
        }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
      if (fieldName == 'owner' || fieldName == 'all') {
        final accountOwner = _accountOwnerController.text.trim().toLowerCase();
        if (accountOwner.isNotEmpty) {
          final nameWords = accountOwner.split(RegExp(r'\s+'));
          int matchedWords = 0;
          
          for (final word in nameWords) {
            // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏ô‡∏≤‡∏¢, ‡∏ô‡∏≤‡∏á, ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô OCR)
            if (word == '‡∏ô‡∏≤‡∏¢' || word == '‡∏ô‡∏≤‡∏á' || word == '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß' || word == 'mr' || word == 'mrs' || word == 'miss') {
              matchedWords++; // ‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
              continue;
            }
            
            if (word.length >= 2 && _ocrText.contains(word)) {
              matchedWords++;
            }
          }
          
          // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 40% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥ (‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠ OCR ‡∏û‡∏•‡∏≤‡∏î‡∏ö‡πâ‡∏≤‡∏á)
          final threshold = nameWords.length * 0.4;
          final isValid = matchedWords >= threshold;
          
          // Debug
          print('üë§ Owner check: "$accountOwner" -> words: $nameWords (${nameWords.length}) -> matched: $matchedWords -> threshold: $threshold -> valid: $isValid');
          
          _accountOwnerError = isValid 
              ? null 
              : '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
        } else {
          _accountOwnerError = null;
        }
      }
    });
  }

  Future<void> _pickLocationFromMap() async {
    // ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
    if (_accountOwnerController.text.isNotEmpty && _ocrText.isNotEmpty) {
      _validateFieldAgainstOCR('owner');
    }
    
    final result = await Navigator.of(context).push<Map<String, double>>(
      MaterialPageRoute(
        builder: (context) => MapPickerScreen(
          initialLatitude: _latitude,
          initialLongitude: _longitude,
        ),
      ),
    );

    if (result != null) {
      setState(() {
        _latitude = result['latitude'];
        _longitude = result['longitude'];
      });
      
      _showSnackBar('‚úÖ ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', Colors.green);
    }
  }

  Future<void> _saveShopRegistration() async {
    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    setState(() {
      _autoValidateMode = AutovalidateMode.always;
    });

    final errors = _validateFields();
    if (errors.isNotEmpty) {
      _showValidationDialog(errors);
      return;
    }

    setState(() => _isSaving = true);

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) throw Exception('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');

      // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡πà‡∏≠‡∏ô
      String? shopImageUrl;
      String? bookBankImageUrl;

      if (_selectedImage != null) {
        shopImageUrl = await _uploadImage();
        if (shopImageUrl == null) throw Exception('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      }

      if (_selectedBookBankImage != null) {
        bookBankImageUrl = await _uploadBookBankImage();
        if (bookBankImageUrl == null) throw Exception('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      }

      // ‡πÉ‡∏ä‡πâ serviceType ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ collection
      final serviceType = widget.serviceType ?? '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
      
      // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö
      final querySnapshot = await FirebaseFirestore.instance
          .collection(serviceType)
          .get();
      
      final orderNumber = querySnapshot.docs.length + 1;

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á Firestore (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏õ‡πá‡∏ô Collection ‡πÅ‡∏¢‡∏Å)
      await FirebaseFirestore.instance
          .collection(serviceType)
          .doc(user.uid)
          .set({
        'name': _shopNameController.text.trim(),
        'type': serviceType,
        'rating': 0.0, // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà 0 ‡∏£‡∏≠‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
        'location': {
          'latitude': _latitude ?? 0.0,
          'longitude': _longitude ?? 0.0,
        },
        'ownerId': user.uid,
        'order': orderNumber, // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ
        'description': _shopDescriptionController.text.trim(),
        'address': 'Lat: ${_latitude!.toStringAsFixed(6)}, Lng: ${_longitude!.toStringAsFixed(6)}',
        'phone': _phoneController.text.trim(),
        'email': _emailController.text.trim(),
        'shopImageUrl': shopImageUrl,
        'bookBankImageUrl': bookBankImageUrl,
        'bankName': _bankNameController.text.trim(),
        'accountNumber': _accountNumberController.text.trim(),
        'accountOwner': _accountOwnerController.text.trim(),
        'status': 'pending', // ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        'createdAt': FieldValue.serverTimestamp(),
      });

      _showSnackBar('‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', Colors.green);
      
      await Future.delayed(const Duration(seconds: 1));
      
      if (mounted) {
        // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Home ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
        Navigator.of(context).pushReplacementNamed('/home');
      }
    } catch (e) {
      _showSnackBar('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: $e', Colors.red);
    } finally {
      if (mounted) {
        setState(() => _isSaving = false);
      }
    }
  }

  void _showSnackBar(String message, Color color) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: color,
        duration: const Duration(seconds: 3),
      ),
    );
  }

  Future<bool?> _showAutoFillConfirmationDialog(Map<String, String> data) async {
    return showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        title: Row(
          children: [
            Icon(Icons.auto_awesome, color: Colors.purple),
            SizedBox(width: 8),
            Text('ü§ñ AI ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß'),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:',
              style: TextStyle(fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 16),
            if (data['bankName'] != null) ...[
              Text('üè¶ ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:', style: TextStyle(fontWeight: FontWeight.w600, color: Colors.grey.shade700)),
              Text(data['bankName']!, style: TextStyle(fontSize: 16)),
              SizedBox(height: 8),
            ],
            if (data['accountNumber'] != null) ...[
              Text('üî¢ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:', style: TextStyle(fontWeight: FontWeight.w600, color: Colors.grey.shade700)),
              Text(data['accountNumber']!, style: TextStyle(fontSize: 16)),
              SizedBox(height: 8),
            ],
            if (data['accountOwner'] != null) ...[
              Text('üë§ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:', style: TextStyle(fontWeight: FontWeight.w600, color: Colors.grey.shade700)),
              Text(data['accountOwner']!, style: TextStyle(fontSize: 16)),
              SizedBox(height: 8),
            ],
            SizedBox(height: 12),
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.orange.shade50,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.orange.shade200),
              ),
              child: Row(
                children: [
                  Icon(Icons.info_outline, color: Colors.orange, size: 20),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                      style: TextStyle(fontSize: 13, color: Colors.orange.shade900),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text('‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ ‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á'),
          ),
          ElevatedButton.icon(
            onPressed: () => Navigator.pop(context, true),
            icon: Icon(Icons.check),
            label: Text('‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô'),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.purple,
              foregroundColor: Colors.white,
            ),
          ),
        ],
      ),
    );
  }

  void _showOCRPreviewDialog(String ocrText) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Row(
          children: [
            Icon(Icons.preview, color: Colors.blue),
            SizedBox(width: 8),
            Text('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ'),
          ],
        ),
        content: Container(
          width: double.maxFinite,
          constraints: BoxConstraints(maxHeight: 400),
          child: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'Vision API ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ ${ocrText.length} ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£:',
                  style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
                ),
                SizedBox(height: 12),
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.grey.shade100,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.grey.shade300),
                  ),
                  child: SelectableText(
                    ocrText,
                    style: TextStyle(fontSize: 13, height: 1.5),
                  ),
                ),
                SizedBox(height: 16),
                Text(
                  '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å:',
                  style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14, color: Colors.orange),
                ),
                SizedBox(height: 8),
                Text('‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: ${_bankNameController.text}', style: TextStyle(fontSize: 13)),
                Text('‚Ä¢ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ${_accountNumberController.text}', style: TextStyle(fontSize: 13)),
                Text('‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ${_accountOwnerController.text}', style: TextStyle(fontSize: 13)),
              ],
            ),
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('‡∏õ‡∏¥‡∏î'),
          ),
        ],
      ),
    );
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  bool _isValidEmail(String email) {
    final regex = RegExp(r'^[^\s@]+@[^\s@]+\.[^\s@]+$');
    return regex.hasMatch(email);
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 0XXXXXXXXX (10 ‡∏´‡∏•‡∏±‡∏Å) ‡∏´‡∏£‡∏∑‡∏≠ +66XXXXXXXXX/66XXXXXXXXX (11 ‡∏´‡∏•‡∏±‡∏Å)
  bool _isValidThaiPhone(String input) {
    final digits = input.replaceAll(RegExp(r'\D'), '');
    if (digits.startsWith('0')) {
      return digits.length == 10;
    }
    if (digits.startsWith('66')) {
      return digits.length == 11; // 66 + 9 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
    }
    return false;
  }

  // ‡∏£‡∏ß‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  List<String> _validateFields() {
    final errors = <String>[];

    final name = _shopNameController.text.trim();
    final phone = _phoneController.text.trim();
    final email = _emailController.text.trim();

    if (name.isEmpty || name.length < 2) {
      errors.add('‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
    }
    if (_latitude == null || _longitude == null) {
      errors.add('‚Ä¢ ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà');
    }
    if (phone.isEmpty || !_isValidThaiPhone(phone)) {
      errors.add('‚Ä¢ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 0812345678 ‡∏´‡∏£‡∏∑‡∏≠ +66812345678)');
    }
    if (email.isEmpty || !_isValidEmail(email)) {
      errors.add('‚Ä¢ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }

    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏∏
    // ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)

    return errors;
  }

  void _showValidationDialog(List<String> errors) {
    showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          title: const Text('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: errors.map((e) => Text(e)).toList(),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text('‡∏ï‡∏Å‡∏•‡∏á'),
            ),
          ],
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'),
        backgroundColor: const Color(0xFFFF6B35),
        foregroundColor: Colors.white,
        elevation: 0,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(24),
        child: Form(
          key: _formKey,
          autovalidateMode: _autoValidateMode,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
              Text(
                '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Colors.grey.shade800,
                ),
              ),
              const SizedBox(height: 24),

              // ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
              TextFormField(
                controller: _shopNameController,
                decoration: InputDecoration(
                  labelText: '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ *',
                  hintText: '‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏°‡∏ä‡∏≤‡∏¢',
                  prefixIcon: const Icon(Icons.store),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                validator: (value) {
                  final v = value?.trim() ?? '';
                  if (v.isEmpty) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤';
                  if (v.length < 2) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
                  return null;
                },
              ),
              
              const SizedBox(height: 16),

              // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÉ‡∏ï‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
              TextFormField(
                controller: _shopDescriptionController,
                maxLines: 1,
                textInputAction: TextInputAction.next,
                decoration: InputDecoration(
                  labelText: '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
                  hintText: '‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô ‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡∏≠‡∏£‡πà‡∏≠‡∏¢',
                  prefixIcon: const Icon(Icons.description),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
              ),

              const SizedBox(height: 24),

              // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
              const Text(
                '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF2C3E50),
                ),
              ),
              const SizedBox(height: 12),
              
              GestureDetector(
                onTap: _isUploading ? null : _pickImage,
                child: Container(
                  height: 200,
                  width: double.infinity,
                  decoration: BoxDecoration(
                    color: Colors.grey.shade100,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: Colors.grey.shade300),
                  ),
                  child: _isUploading
                      ? const Center(
                          child: CircularProgressIndicator(),
                        )
                      : _selectedImage != null
                          ? ClipRRect(
                              borderRadius: BorderRadius.circular(12),
                              child: Image.file(
                                _selectedImage!,
                                fit: BoxFit.cover,
                              ),
                            )
                          : Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  Icons.add_photo_alternate,
                                  size: 64,
                                  color: Colors.grey.shade400,
                                ),
                                const SizedBox(height: 8),
                                Text(
                                  '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û',
                                  style: TextStyle(
                                    color: Colors.grey.shade600,
                                    fontSize: 16,
                                  ),
                                ),
                              ],
                            ),
                ),
              ),
              
              const SizedBox(height: 24),

              // ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
              const Text(
                '‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF2C3E50),
                ),
              ),
              const SizedBox(height: 12),

              GestureDetector(
                onTap: _isUploadingBookBank ? null : _pickBookBankImage,
                child: Container(
                  height: 160,
                  width: double.infinity,
                  decoration: BoxDecoration(
                    color: Colors.grey.shade100,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: Colors.grey.shade300),
                  ),
                  child: _isUploadingBookBank
                      ? const Center(child: CircularProgressIndicator())
                      : _selectedBookBankImage != null
                          ? ClipRRect(
                              borderRadius: BorderRadius.circular(12),
                              child: Image.file(
                                _selectedBookBankImage!,
                                fit: BoxFit.cover,
                              ),
                            )
                          : Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  Icons.credit_card,
                                  size: 56,
                                  color: Colors.grey.shade400,
                                ),
                                const SizedBox(height: 8),
                                Text(
                                  '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
                                  style: TextStyle(
                                    color: Colors.grey.shade600,
                                    fontSize: 14,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                const Text(
                                  '‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô',
                                  style: TextStyle(fontSize: 12, color: Colors.grey),
                                )
                              ],
                            ),
                ),
              ),

              const SizedBox(height: 16),

              // ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Dropdown)
              DropdownButtonFormField<String>(
                value: _bankNameController.text.isNotEmpty && _thaiBanks.contains(_bankNameController.text)
                    ? _bankNameController.text
                    : null,
                items: _thaiBanks
                    .map((bank) => DropdownMenuItem<String>(
                          value: bank,
                          child: Text(bank),
                        ))
                    .toList(),
                decoration: InputDecoration(
                  labelText: '‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ *',
                  hintText: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£',
                  prefixIcon: const Icon(Icons.account_balance),
                  errorText: _bankNameError,
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                onChanged: (value) {
                  setState(() {
                    _bankNameController.text = value ?? '';
                  });
                  _validateFieldAgainstOCR('bank');
                },
                validator: (value) {
                  final val = (value ?? _bankNameController.text).trim();
                  if (val.isEmpty) {
                    return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 16),

              // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
              TextFormField(
                controller: _accountNumberController,
                keyboardType: TextInputType.text, // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô text ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡∏µ‡∏î‡πÑ‡∏î‡πâ
                decoration: InputDecoration(
                  labelText: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ *',
                  hintText: '‡πÄ‡∏ä‡πà‡∏ô 164-3-44034-9 ‡∏´‡∏£‡∏∑‡∏≠ 1643440349',
                  helperText: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ç‡∏µ‡∏î‡∏Ñ‡∏±‡πà‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ',
                  helperStyle: TextStyle(fontSize: 12, color: Colors.grey.shade600),
                  prefixIcon: const Icon(Icons.credit_card),
                  errorText: _accountNumberError,
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                onTap: () {
                  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                  if (_bankNameController.text.isNotEmpty && _ocrText.isNotEmpty) {
                    _validateFieldAgainstOCR('bank');
                  }
                },
                onChanged: (value) {
                  _validateFieldAgainstOCR('account');
                },
                validator: (value) {
                  if (value == null || value.trim().isEmpty) {
                    return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
                  }
                  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ç‡∏µ‡∏î
                  final cleaned = value.trim().replaceAll(RegExp(r'[^0-9\-]'), '');
                  if (cleaned.length < 8) {
                    return '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏´‡∏•‡∏±‡∏Å';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 16),

              // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
              TextFormField(
                controller: _accountOwnerController,
                decoration: InputDecoration(
                  labelText: '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ *',
                  hintText: '‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
                  prefixIcon: const Icon(Icons.person),
                  errorText: _accountOwnerError,
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                onTap: () {
                  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                  if (_accountNumberController.text.isNotEmpty && _ocrText.isNotEmpty) {
                    _validateFieldAgainstOCR('account');
                  }
                },
                onChanged: (value) {
                  _validateFieldAgainstOCR('owner');
                },
                validator: (value) {
                  if (value == null || value.trim().isEmpty) {
                    return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 16),

              // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
              const Text(
                '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ *',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF2C3E50),
                ),
              ),
              const SizedBox(height: 12),
              
              // ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
              InkWell(
                onTap: _pickLocationFromMap,
                borderRadius: BorderRadius.circular(12),
                child: Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: _latitude != null && _longitude != null
                        ? Colors.green.shade50
                        : Colors.grey.shade100,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: _latitude != null && _longitude != null
                          ? Colors.green.shade300
                          : Colors.grey.shade300,
                      width: 2,
                    ),
                  ),
                  child: Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: _latitude != null && _longitude != null
                              ? Colors.green.shade100
                              : Colors.orange.shade100,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.location_pin,
                          color: _latitude != null && _longitude != null
                              ? Colors.green.shade700
                              : const Color(0xFFFF6B35),
                          size: 32,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              _latitude != null && _longitude != null
                                  ? '‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß'
                                  : '‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤',
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: _latitude != null && _longitude != null
                                    ? Colors.green.shade700
                                    : Colors.grey.shade700,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              _latitude != null && _longitude != null
                                  ? 'Lat: ${_latitude!.toStringAsFixed(6)}\nLng: ${_longitude!.toStringAsFixed(6)}'
                                  : '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
                              style: TextStyle(
                                fontSize: 13,
                                color: _latitude != null && _longitude != null
                                    ? Colors.green.shade600
                                    : Colors.grey.shade600,
                              ),
                            ),
                          ],
                        ),
                      ),
                      Icon(
                        Icons.arrow_forward_ios,
                        color: Colors.grey.shade400,
                        size: 20,
                      ),
                    ],
                  ),
                ),
              ),
              
              const SizedBox(height: 16),

              // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
              TextFormField(
                controller: _phoneController,
                keyboardType: TextInputType.phone,
                decoration: InputDecoration(
                  labelText: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *',
                  hintText: '‡πÄ‡∏ä‡πà‡∏ô 081-234-5678',
                  prefixIcon: const Icon(Icons.phone),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                validator: (value) {
                  final v = value?.trim() ?? '';
                  if (v.isEmpty) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå';
                  if (!_isValidThaiPhone(v)) {
                    return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 0812345678 ‡∏´‡∏£‡∏∑‡∏≠ +66812345678)';
                  }
                  return null;
                },
              ),
              
              const SizedBox(height: 16),

              // ‡∏≠‡∏µ‡πÄ‡∏°‡∏•
              TextFormField(
                controller: _emailController,
                keyboardType: TextInputType.emailAddress,
                decoration: InputDecoration(
                  labelText: '‡∏≠‡∏µ‡πÄ‡∏°‡∏• *',
                  hintText: 'example@email.com',
                  prefixIcon: const Icon(Icons.email),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                validator: (value) {
                  final v = value?.trim() ?? '';
                  if (v.isEmpty) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
                  if (!_isValidEmail(v)) return '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                  return null;
                },
              ),
              
              const SizedBox(height: 32),

              // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              SizedBox(
                width: double.infinity,
                height: 52,
                child: ElevatedButton(
                  onPressed: (_isSaving || _isUploading)
                      ? null
                      : _saveShopRegistration,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFFFF6B35),
                    foregroundColor: Colors.white,
                    disabledBackgroundColor: Colors.grey.shade300,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: _isSaving
                      ? const SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                          ),
                        )
                      : const Text(
                          '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                ),
              ),
              
              const SizedBox(height: 16),

              // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
              Center(
                child: Text(
                  '* ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å',
                  style: TextStyle(
                    fontSize: 14,
                    color: Colors.grey.shade600,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
